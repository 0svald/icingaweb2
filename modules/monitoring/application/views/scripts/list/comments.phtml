<?php
    $dateHelper = $this->getHelper('DateFormat');

    /** @var Zend_View_Helper_CommandForm $commandHelper */
    $commandHelper = $this->getHelper('CommandForm');
?>
<?= $this->tabs->render($this); ?>

<?php
$viewHelper = $this->getHelper('MonitoringState');
?>

<h1>Comments</h1>

<div data-icinga-component="app/mainDetailGrid" data-icinga-grid-selection-type="single">

  <?=  $this->sortControl->render($this); ?>


  <?=  $this->paginationControl($comments, null, null, array('preserve' => $this->preserve)); ?>

  <table class="table table-condensed">
    <tbody>
    <?php foreach ($comments as $comment): ?>
      <?php
        $objectType = ($comment->comment_objecttype_id === '1') ? 'host' : 'service';
        $objectName = ($objectType === 'host') ? $comment->host_name : $comment->service_name;
        $hrefParameters = array(
          $objectType   => $objectName,
          'comment_id'  => $comment->comment_id
        );
        if ($objectType === 'service') {
          $hrefParameters['host'] = $comment->host_name;
        }

        $detailLink = $this->href(
          'monitoring/show/' . $objectType,
          $hrefParameters
        );

        $hostLink = $this->href(
          'monitoring/show/host',
          array(
            'host' => $comment->host_name
          )
        );
      ?>
    <tr>
        <td>
          <a class="hidden" href="<?= $detailLink; ?>"></a>
          <?php if ($comment->comment_objecttype_id === '1'): ?>
            <i class="icinga-icon-host" rel="tooltip" title="Host comment" ></i>
          <?php elseif ($comment->comment_objecttype_id === '2'): ?>
            <i class="icinga-icon-service" rel="tooltip" title="Service comment"></i>
          <?php endif; ?>
        </td>

        <td>
          <small>
              <?php
              switch ($comment->comment_type) {
                  case 'flapping':
                      $icon = 'icinga-icon-flapping';
                      $tooltip = 'Comment is caused by a flapping host or service.';
                      break;
              }
              ?>
              <i class="<?= $icon ?>" rel="tooltip" title="<?= $tooltip ?>"> </i>
          </small>
        </td>

        <div rel="tooltip" title="Comment #<?=$comment->comment_id ?>">
        <td>
            <?php if ($comment->service_name): ?>
                <a href="<?= $detailLink ?>">
                    <?= $comment->service_name ?>
                </a>
                on
            <?php else: ?>
                &nbsp;
            <?php endif; ?>
            <a href="<?= $hostLink ?>">
                <?= $comment->host_name; ?>
            </a>
        </td>
        <td>
          <?= date('d.m. H:i', $comment->comment_timestamp); ?>
        </td>
        <td>
          <?= $comment->comment_author; ?>
        </td>
        <td>
          <div class="small-row">
             <?= $comment->comment_data; ?>
          </div>
        </td>
        <td>
          <?= ($comment->comment_is_persistent === '1') ? 'Yes' : 'No'; ?>
        </td>
        <td>
          <small>
           expires <br /> <?=
            ($comment->comment_expiration_timestamp) ?
            'at ' . date('d.m H:i', $comment->comment_expiration_timestamp) :
            'Never';
          ?>          </small>

        </td>
        <td>
          <?php
            $data = array(
              'commentid' => $comment->comment_id,
              'host'      => $comment->host_name
            );

            if ($objectType === 'service') {
              $data['service'] = $comment->service_name;
            }

            echo $commandHelper->iconSubmitForm(
                'icinga-icon-remove',
                'Remove comment',
                'btn-small',
                'removecomment',
                $data
            );
          ?>
        </td>
        </div>
      </tr>
    <?php endforeach; ?>
    </tbody>
  </table>

  <?=  $this->paginationControl($comments, null, null, array('preserve' => $this->preserve)); ?>
</div>