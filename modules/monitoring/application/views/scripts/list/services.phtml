<?php
$helper = $this->getHelper('MonitoringState');

if (!$this->compact): ?>
<div class="controls">
<?= $this->tabs ?>
<div style="display: inline-block; margin: 1em; vertical-align: top;">
<?= $this->filterBox->render($this); ?>
</div>
<div style="display: inline-block; margin: 1em; vertical-align: top;">
<?= $this->sortControl->render($this); ?>
</div><br />
<div style="display: inline-block; margin: 1em; vertical-align: top;">
<?= $this->selectionToolbar('multi', $this->href('monitoring/multi/service', array( 'service' => '*', 'host' => '*' ))); ?></div> <?=  $this->paginationControl($services, null, null, array('preserve' => $this->preserve)); ?>
</div>

<div class="content">
<?php endif ?>
<table class="action multiselect<?php if ($this->compact): ?> compact<?php endif ?>">
  <tbody>
<?php

foreach ($services as $service):
    $serviceLink = $this->href(
      'monitoring/show/service',
      array(
        'host' => $service->host_name,
        'service' => $service->service_description
      )
    );
    $hostLink = $this->href(
      'monitoring/show/host',
      array(
        'host' => $service->host_name,
      )
    );
    $serviceStateName = strtolower($this->util()->getServiceStateName($service->service_state));
?>
    <tr class="state <?= $serviceStateName ?><?= $service->service_handled ? ' handled' : '' ?>">
      <td class="state" title="<?= $helper->getStateTitle($service, 'service'); ?>">
        <strong><?= strtoupper($helper->monitoringState($service, 'service')); ?></strong><br />

            <?php if (!$this->compact): ?>Since <?php endif ?><?= $this->timeSince($service->service_last_state_change); ?>
            <?php if ($service->service_state > 0 && (int) $service->service_state_type === 0): ?>
              <br />
              <strong>Soft <?= $service->service_attempt ?></strong>
            <?php endif ?>
      </td>

      <td title="<?= $helper->getStateTitle($service, 'host'); ?>">

        <?= $this->perfdata($service->service_perfdata, true) ?>

        <?php if (!$service->service_handled && $service->service_state > 0): ?>
        <?= $this->img('img/icons/unhandled.png', array(
          'title' => 'Unhandled',
        )) ?>
        <?php endif ?>

        <?php if ($service->service_acknowledged && !$service->service_in_downtime): ?>
        <?= $this->img('img/icons/acknowledgement.png', array(
          'title' => 'Acknowledged',
        )) ?>
        <?php endif ?>

        <?php if ($service->service_is_flapping): ?>
        <?= $this->img('img/icons/flapping.png', array(
          'title' => 'Flapping',
        )) ?>
        <?php endif ?>

        <?php if (!$service->service_notifications_enabled): ?>
        <?= $this->img('img/icons/notification_disabled.png', array(
          'title' => 'Notifications Disabled',
        )) ?>
        <?php endif ?>

        <?php if ($service->service_in_downtime): ?>
        <?= $this->img('img/icons/in_downtime.png', array(
          'title' => 'In Downtime',
        )) ?>
        <?php endif ?>

        <?php if (!$service->service_active_checks_enabled): ?>
          <?php if (!$service->service_passive_checks_enabled): ?>
            <?= $this->img('img/icons/active_passive_checks_disabled.png', array(
              'title' => 'Active And Passive Checks Disabled',
            )) ?>
          <?php else: ?>
            <?= $this->img('img/icons/active_checks_disabled.png', array(
              'title' => 'Active Checks Disabled',
            )) ?>
          <?php endif ?>
        <?php endif ?>

      <?php if ($service->service_icon_image): ?>
      <?= $this->img($this->resolveMacros($service->service_icon_image, $service), array('align' => 'left')) ?>
      <?php endif ?>
<a href="<?= $serviceLink ?>"><?= $service->service_display_name ?></a> on <a href="<?= $hostLink ?>"><?= $service->host_name; ?>
<?php if ($service->host_state != 0): ?>
 (<?= ucfirst($helper->monitoringState($service, 'host')); ?>)
<?php endif ?>
</a><br />
        <p class="pluginoutput"><?= $this->escape(substr(strip_tags($service->service_output), 0, 10000)); ?></p>
      </td>
    </tr>
<?php endforeach ?>
  </tbody>
</table>
<?php if (!$this->compact): ?>
</div>
<?php endif ?>
