<?php
use Icinga\Module\Monitoring\Object\Host;
use Icinga\Module\Monitoring\Web\Widget\StateBadges;

if (! $this->compact): ?>
<div class="controls">
  <?= $this->tabs ?>
  <?= $this->sortBox ?>
  <?= $this->limiter ?>
  <?= $this->paginator ?>
  <?= $this->filterEditor ?>
</div>
<?php endif ?>
<div class="content">
<?php if (! $hostgroups->hasResult()): ?>
    <p><?= $this->translate('No host groups found matching the filter.') ?></p>
    </div>
<?php return; endif ?>
<table class="action-table listing-table" data-base-target="_next">
    <thead>
        <tr>
            <th><?= $this->translate('Host Group') ?></th>
            <th><?= $this->translate('Total Hosts') ?></th>
            <th><?= $this->translate('Host States') ?></th>
            <th><?= $this->translate('Total Services') ?></th>
            <th><?= $this->translate('Service States') ?></th>
        </tr>
    </thead>
    <tbody>
<?php foreach ($hostgroups as $hostgroup): ?>
      <tr href="<?= $this->href('monitoring/list/hosts', array('hostgroup_name' => $hostgroup->hostgroup_name)) ?>">
        <td class="groupname">
          <?= $this->qlink(
            $hostgroup->hostgroup_alias,
            'monitoring/list/hosts',
            array('hostgroup_name' => $hostgroup->hostgroup_name),
            array('title' => sprintf($this->translate('List all hosts in the group "%s"'), $hostgroup->hostgroup_alias))
          ) ?>
        </td>
        <td class="total">
          <?= $this->qlink(
            $hostgroup->hosts_total,
            'monitoring/list/hosts',
            array('hostgroup_name' => $hostgroup->hostgroup_name),
            array('title' => sprintf(
                $this->translate('List all hosts in host group "%s"'),
                $hostgroup->hostgroup_alias
            ))
          ) ?>
        </td>
        <td>
            <?php
            $stateBadges = new StateBadges();
            $stateBadges
                ->setUrl('monitoring/list/hosts')
                ->add(
                    StateBadges::STATE_OK,
                    array(
                        'host_state'        => 0,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'host_severity'
                    ),
                    $hostgroup->hosts_up,
                    'List %u host that is currently in state UP in the host group "%s"',
                    'List %u hosts which are currently in state UP in the host group "%s"',
                    array($hostgroup->hosts_up, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_CRITICAL,
                    array(
                        'host_state'        => 1,
                        'host_acknowledged' => 0,
                        'host_in_downtime'  => 0,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'host_severity'
                    ),
                    $hostgroup->hosts_down_unhandled,
                    'List %u host that is currently in state DOWN in the host group "%s"',
                    'List %u hosts which are currently in state DOWN in the host group "%s"',
                    array($hostgroup->hosts_down_unhandled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_CRITICAL_HANDLED,
                    array(
                        'host_state'      => 1,
                        'host_handled'    => 1,
                        'hostgroup_name'  => $hostgroup->hostgroup_name,
                        'sort'            => 'host_severity'
                    ),
                    $hostgroup->hosts_down_handled,
                    'List %u host that is currently in state DOWN (Acknowledged) in the host group "%s"',
                    'List %u hosts which are currently in state DOWN (Acknowledged) in the host group "%s"',
                    array($hostgroup->hosts_down_handled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_UNREACHABLE,
                    array(
                        'host_state'        => 2,
                        'host_acknowledged' => 0,
                        'host_in_downtime'  => 0,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'host_severity'
                    ),
                    $hostgroup->hosts_unreachable_unhandled,
                    'List %u host that is currently in state UNREACHABLE in the host group "%s"',
                    'List %u hosts which are currently in state UNREACHABLE in the host group "%s"',
                    array($hostgroup->hosts_unreachable_unhandled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_UNREACHABLE_HANDLED,
                    array(
                        'host_state'      => 2,
                        'host_handled'    => 1,
                        'hostgroup_name'  => $hostgroup->hostgroup_name,
                        'sort'            => 'host_severity'
                    ),
                    $hostgroup->hosts_unreachable_handled,
                    'List %u host that is currently in state UNREACHABLE (Acknowledged) in the host group "%s"',
                    'List %u hosts which are currently in state UNREACHABLE (Acknowledged) in the host group "%s"',
                    array($hostgroup->hosts_unreachable_handled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_PENDING,
                    array(
                        'host_state'        => 99,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'host_severity'
                    ),
                    $hostgroup->hosts_pending,
                    'List %u host that is currently in state PENDING in the host group "%s"',
                    'List %u hosts which are currently in state PENDING in the host group "%s"',
                    array($hostgroup->hosts_pending, $hostgroup->hostgroup_alias)
                );
                echo $stateBadges->render();
            ?>
        </td>
        <td class="total">
          <?= $this->qlink(
            $hostgroup->services_total,
            'monitoring/list/services',
            array('hostgroup_name' => $hostgroup->hostgroup_name),
            array('title' => sprintf(
                $this->translate('List all services of all hosts in host group "%s"'),
                $hostgroup->hostgroup_alias
            ))
          ) ?>
        </td>
        <td>
            <?php
            $stateBadges = new StateBadges();
            $stateBadges
                ->setUrl('monitoring/list/services')
                ->add(
                    StateBadges::STATE_OK,
                    array(
                        'service_state'     => 0,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'service_severity'
                    ),
                    $hostgroup->services_ok,
                    'List %u service that is currently in state OK on hosts in the host group "%s"',
                    'List %u services which are currently in state OK on hosts in the host group "%s"',
                    array($hostgroup->services_ok, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_CRITICAL,
                    array(
                        'service_state'         => 2,
                        'service_acknowledged'  => 0,
                        'service_in_downtime'   => 0,
                        'host_problem'          => 0,
                        'hostgroup_name'        => $hostgroup->hostgroup_name,
                        'sort'                  => 'service_severity'
                    ),
                    $hostgroup->services_critical_unhandled,
                    'List %u service that is currently in state CRITICAL on hosts in the host group "%s"',
                    'List %u services which are currently in state CRITICAL on hosts in the host group "%s"',
                    array($hostgroup->services_critical_unhandled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_CRITICAL_HANDLED,
                    array(
                        'service_state'     => 2,
                        'service_handled'   => 1,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'service_severity'
                    ),
                    $hostgroup->services_critical_handled,
                    'List %u service that is currently in state CRITICAL (Acknowledged) on hosts in the host group "%s"',
                    'List %u services which are currently in state CRITICAL (Acknowledged) on hosts in the host group "%s"',
                    array($hostgroup->services_critical_unhandled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_UNKNOWN,
                    array(
                        'service_state'         => 3,
                        'service_acknowledged'  => 0,
                        'service_in_downtime'   => 0,
                        'host_problem'          => 0,
                        'hostgroup_name'        => $hostgroup->hostgroup_name,
                        'sort'                  => 'service_severity'
                    ),
                    $hostgroup->services_unknown_unhandled,
                    'List %u service that is currently in state UNKNOWN on hosts in the host group "%s"',
                    'List %u services which are currently in state UNKNOWN on hosts in the host group "%s"',
                    array($hostgroup->services_unknown_unhandled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_UNKNOWN_HANDLED,
                    array(
                        'service_state'     => 3,
                        'service_handled'   => 1,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'service_severity'
                    ),
                    $hostgroup->services_unknown_handled,
                    'List %u service that is currently in state UNKNOWN (Acknowledged) on hosts in the host group "%s"',
                    'List %u services which are currently in state UNKNOWN (Acknowledged) on hosts in the host group "%s"',
                    array($hostgroup->services_unknown_handled, $hostgroup->hostgroup_alias)

                )
                ->add(
                    StateBadges::STATE_WARNING,
                    array(
                        'service_state'         => 1,
                        'service_acknowledged'  => 0,
                        'service_in_downtime'   => 0,
                        'host_problem'          => 0,
                        'hostgroup_name'        => $hostgroup->hostgroup_name,
                        'sort'                  => 'service_severity'
                    ),
                    $hostgroup->services_warning_unhandled,
                    'List %u service that is currently in state WARNING on hosts in the host group "%s"',
                    'List %u services which are currently in state WARNING on hosts in the host group "%s"',
                    array($hostgroup->services_warning_unhandled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_WARNING_HANDLED,
                    array(
                        'service_state'     => 1,
                        'service_handled'   => 1,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'service_severity'
                    ),
                    $hostgroup->services_warning_handled,
                    'List %u service that is currently in state WARNING (Acknowledged) on hosts in the host group "%s"',
                    'List %u services which are currently in state WARNING (Acknowledged) on hosts in the host group "%s"',
                    array($hostgroup->services_warning_handled, $hostgroup->hostgroup_alias)
                )
                ->add(
                    StateBadges::STATE_PENDING,
                    array(
                        'service_state'     => 99,
                        'hostgroup_name'    => $hostgroup->hostgroup_name,
                        'sort'              => 'service_severity'
                    ),
                    $hostgroup->services_pending,
                    'List %u service that is currently in state PENDING on hosts in the host group "%s"',
                    'List %u services which are currently in state PENDING on hosts in the host group "%s"',
                    array($hostgroup->services_pending, $hostgroup->hostgroup_alias)
                );
            echo $stateBadges->render();
            ?>
        </td>
      </tr>
<?php endforeach ?>
    </tbody>
  </table>
<?php if ($hostgroups->hasMore()): ?>
  <?= $this->qlink(
    $this->translate('Show More'),
    $this->url()->without(array('view', 'limit')),
    null,
    array(
      'data-base-target'    => '_next',
      'class'               => 'pull-right show-more'
    )
  ) ?>
<?php endif ?>
</div>
